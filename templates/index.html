<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Reef Controller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet" />
    <style>
        #refreshLoader {
            position: fixed;
            right: 12px;
            bottom: 12px;
            width: 220px;
            z-index: 1050;
        }
    </style>
</head>

<body>
    <div class="container py-3 py-md-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
            <div>
                <h1 class="h3 mb-1">Reef Controller</h1>
                <p class="text-secondary small mb-0">Contrôle aquarium – Arduino Mega + interface web</p>
            </div>
            <div class="d-flex flex-column flex-md-row gap-2 align-items-md-center">
                <div class="d-flex align-items-center gap-2">
                    <span class="small text-secondary">Port série</span>
                    <select id="portSelect" class="form-select form-select-sm" style="min-width: 210px;"></select>
                    <button class="btn btn-sm btn-outline-light" data-action="refreshPorts">↻</button>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span id="statusBadge" class="badge reef-badge bg-secondary-subtle text-uppercase">Déconnecté</span>
                    <button class="btn btn-sm btn-outline-light" data-action="connect">Connecter</button>
                    <button class="btn btn-sm btn-outline-danger" data-action="disconnect">Déconnecter</button>
                </div>
            </div>
        </div>

        <div id="megaError" class="alert alert-danger py-2 px-3 small d-none"></div>

        <ul class="nav nav-pills mb-3" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-dashboard" type="button"
                    role="tab">Dashboard</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-pumps" type="button"
                    role="tab">Pompes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-heat" type="button"
                    role="tab">Chauffes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-light" type="button"
                    role="tab">Éclairage</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-water" type="button"
                    role="tab">Eau</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-feeder" type="button"
                    role="tab">Nourriture</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-config" type="button"
                    role="tab">Configuration</button>
            </li>


        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-dashboard" role="tabpanel">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="reef-card h-100">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="fw-semibold">🌡️ Températures</div>
                                <button class="btn btn-sm btn-aqua" data-action="readTemps">Actualiser</button>
                            </div>
                            <div class="row">
                                <div class="col-6 mb-2">
                                    <div class="temp-main" id="temp1_val">--.-°C</div>
                                    <div class="temp-small text-secondary" id="temp1_label">Temp 1</div>
                                </div>
                                <div class="col-6 mb-2">
                                    <div class="temp-main" id="temp2_val">--.-°C</div>
                                    <div class="temp-small text-secondary" id="temp2_label">Temp 2</div>
                                </div>
                                <div class="col-12">
                                    <div class="temp-main" id="temp3_val">--.-°C</div>
                                    <div class="temp-small text-secondary" id="temp3_label">Temp 3</div>
                                </div>
                                <div class="col-6 mb-2">
                                    <div class="temp-main" id="temp4_val">--.-°C</div>
                                    <div class="temp-small text-secondary" id="temp4_label">Temp 4</div>
                                </div>
                            </div>
                            <hr class="border-secondary-subtle" />
                            <div class="d-flex justify-content-between small mb-1">
                                <span>Consigne eau</span>
                                <span id="tset_water_label">--.-°C</span>
                            </div>
                            <div class="d-flex justify-content-between small">
                                <span>Consigne réserve</span>
                                <span id="tset_res_label">--.-°C</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="reef-card h-100">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="fw-semibold">💧 Niveaux / Sécurité</div>
                                <button class="btn btn-sm btn-outline-light" data-action="readLevels">Refresh</button>
                            </div>
                            <div class="mb-2">
                                <div class="section-title mb-1">Niveaux</div>
                                <div class="d-flex flex-wrap gap-1">
                                    <span id="lvl_low" class="badge level-pill level-pill-unk">Bac bas: ?</span>
                                    <span id="lvl_high" class="badge level-pill level-pill-unk">Bac haut: ?</span>
                                    <span id="lvl_alert" class="badge level-pill level-pill-unk">Alarme: ?</span>
                                </div>
                            </div>
                            <hr class="border-secondary-subtle" />
                            <div class="mb-2">
                                <div class="section-title mb-1">Protection</div>
                                <div class="d-flex align-items-center gap-2">
                                    <span id="protectBadge" class="badge reef-badge badge-protect-off">PROTECT
                                        OFF</span>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="protectChk"
                                            data-change="protectToggle" />
                                        <label class="form-check-label small" for="protectChk">Arrêt auto pompes sur
                                            niveau bas</label>
                                    </div>
                                </div>
                            </div>
                            <hr class="border-secondary-subtle" />
                            <div>
                                <div class="section-title mb-1">Servo nourrisseur</div>
                                <div class="input-group input-group-sm mb-2">
                                    <span class="input-group-text">Angle</span>
                                    <input id="servoAngle" type="number" class="form-control" />
                                    <button class="btn btn-aqua" data-action="applyServo">Set</button>
                                </div>
                                <button class="btn btn-sm btn-outline-light w-100" data-action="dispenseMacro">Séquence
                                    distribution</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-pumps" role="tabpanel">
                <div class="reef-card">
                    <div class="fw-semibold mb-2">⛲ Pompes péristaltiques</div>
                    <div class="row g-2 align-items-end mb-2">
                        <div class="col-6 col-md-4 d-grid">
                            <button class="btn btn-sm btn-aqua" data-action="motorRaw" data-cmd="MTR ON">MTR ON</button>
                        </div>
                        <div class="col-6 col-md-4 d-grid">
                            <button class="btn btn-sm btn-danger" data-action="emergencyStop">MTR OFF</button>
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="mtrAutoChk" data-change="mtrAutoToggle"
                            checked />
                        <label class="form-check-label small" for="mtrAutoChk">Moteurs auto-OFF après mouvement</label>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="border rounded p-2 d-flex justify-content-between align-items-center">
                                <div>
                                    <div id="pumpLabel_X" class="fw-semibold small">Pompe X</div>
                                    <div id="pumpInfo_X" class="small text-secondary">-</div>
                                </div>
                                <button class="btn btn-sm btn-aqua" data-action="pumpGo" data-axis="X">Go</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-2 d-flex justify-content-between align-items-center">
                                <div>
                                    <div id="pumpLabel_Y" class="fw-semibold small">Pompe Y</div>
                                    <div id="pumpInfo_Y" class="small text-secondary">-</div>
                                </div>
                                <button class="btn btn-sm btn-aqua" data-action="pumpGo" data-axis="Y">Go</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-2 d-flex justify-content-between align-items-center">
                                <div>
                                    <div id="pumpLabel_Z" class="fw-semibold small">Pompe Z</div>
                                    <div id="pumpInfo_Z" class="small text-secondary">-</div>
                                </div>
                                <button class="btn btn-sm btn-aqua" data-action="pumpGo" data-axis="Z">Go</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-2 d-flex justify-content-between align-items-center">
                                <div>
                                    <div id="pumpLabel_E" class="fw-semibold small">Pompe E</div>
                                    <div id="pumpInfo_E" class="small text-secondary">-</div>
                                </div>
                                <button class="btn btn-sm btn-aqua" data-action="pumpGo" data-axis="E">Go</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-heat" role="tabpanel">
                <div class="reef-card mb-3">
                    <div class="fw-semibold mb-3">🔥 Chauffes</div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small">Eau consigne °C</label>
                            <div class="input-group input-group-sm">
                                <input id="tset_water2" type="number" step="0.1" class="form-control" />
                                <button class="btn btn-aqua" data-action="applyWater">Appliquer</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Réserve consigne °C</label>
                            <div class="input-group input-group-sm">
                                <input id="tset_res2" type="number" step="0.1" class="form-control" />
                                <button class="btn btn-aqua" data-action="applyRes">Appliquer</button>
                            </div>
                        </div>
                    </div>
                    <hr class="border-secondary-subtle" />
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="heatModeSwitch" data-change="heatMode"
                            checked />
                        <label class="form-check-label small" for="heatModeSwitch">Mode automatique</label>
                    </div>
                    <div class="d-flex align-items-center gap-2 mt-2">
                        <span id="heatStatusLabel" class="small text-secondary">Mode automatique</span>
                        <button class="btn btn-sm btn-outline-light" id="heatPowerBtn"
                            data-action="heatPower">Éteindre</button>
                    </div>
                </div>
                <div class="reef-card mb-3">
                    <div class="fw-semibold mb-2">Hystérésis (deadband)</div>
                    <div class="input-group input-group-sm" style="max-width: 220px;">
                        <span class="input-group-text">± °C</span>
                        <input id="heatHyst" type="number" step="0.05" min="0" class="form-control" />
                        <button class="btn btn-aqua" data-action="applyHeatHyst">Enregistrer</button>
                    </div>
                    <small class="text-secondary">Appliqué autour de la consigne eau (ex: ±0,3°C).</small>
                </div>
                <div class="reef-card mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="fw-semibold">🌀 Ventilation</div>
                        <button class="btn btn-sm btn-outline-light" data-action="applyAutocool">Appliquer
                            seuil</button>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between small">
                            <span>Mode</span>
                            <span class="badge reef-badge" id="autoFanModeBadge">Auto</span>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoFanChk"
                                data-change="autoFanToggle" />
                            <label class="form-check-label small" for="autoFanChk">Auto (seuil eau)</label>
                        </div>
                    </div>
                    <hr class="border-secondary-subtle" />
                    <div class="mb-3">
                        <div class="d-flex align-items-center gap-2 small">
                            <span>Seuil (°C)</span>
                            <input id="auto_thresh" type="number" step="0.1" class="form-control form-control-sm"
                                style="width: 100px;" />
                            <span id="auto_thresh_label" class="text-secondary">--.-</span>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-semibold small">Manuel</span>
                        <button class="btn btn-sm btn-outline-light" id="fanToggleBtn"
                            data-action="fanToggle">Allumer</button>
                    </div>
                </div>
            </div>

            {% set day_labels = [
            ('monday','Lundi'),
            ('tuesday','Mardi'),
            ('wednesday','Mercredi'),
            ('thursday','Jeudi'),
            ('friday','Vendredi'),
            ('saturday','Samedi'),
            ('sunday','Dimanche')
            ] %}
            <div class="tab-pane fade" id="tab-light" role="tabpanel">
                <div class="row g-3">
                    <div class="col-12">
                        <div class="reef-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-semibold">Contrôle manuel</div>
                                    <div class="small text-secondary" id="lightStateLabel">Éteinte</div>
                                </div>
                                <button class="btn btn-sm btn-outline-light" id="lightToggleBtn"
                                    data-action="toggleLight">Allumer</button>
                            </div>
                            <div class="mt-3 d-flex align-items-center gap-3">
                                <span class="small text-secondary">Automisation</span>
                                <input id="lightAutoSlider" type="range" min="0" max="1" step="1" class="form-range"
                                    style="width: 160px;" data-change="lightAuto" />
                                <span id="lightAutoLabel" class="fw-semibold text-white small">Auto</span>
                            </div>
                            <p class="small text-secondary mb-0">Désactivez pour gérer l’éclairage manuellement.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-water" role="tabpanel">
                <div class="reef-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="fw-semibold">Suivi pH</div>
                        <button class="btn btn-sm btn-outline-light" data-action="readTemps">Rafraîchir</button>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="reef-stat">
                                <div class="reef-stat-label">Tension sonde (0-5V)</div>
                                <div class="reef-stat-value" id="ph_v_val">--.- V</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="reef-stat">
                                <div class="reef-stat-label">ADC brut</div>
                                <div class="reef-stat-value" id="ph_raw_val">----</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="reef-stat">
                                <div class="reef-stat-label">pH estimé</div>
                                <div class="reef-stat-value" id="ph_val">--.-</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-secondary small mb-0">
                                PH-4502C branché sur T0 (A13). Thermistances : auxiliaire sur A12 (AUX-2). Températures
                                : eau X-MIN (D3), air X-MAX (D2), Y-Min (D14), Y-Max (D15).
                            </div>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <div class="reef-stat">
                                <div class="reef-stat-label" id="temp4_label2">Temp 4</div>
                                <div class="reef-stat-value" id="temp4_val2">--.-°C</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="reef-stat">
                                <div class="reef-stat-label" id="temp2_label2">Temp 2</div>
                                <div class="reef-stat-value" id="temp2_val2">--.-°C</div>
                            </div>
                        </div>
                    </div>
                    <div class="reef-card mt-3 d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-semibold mb-1">Pompe principale</div>
                            <div class="small text-secondary" id="pumpStateLabel">Inconnue</div>
                        </div>
                        <button class="btn btn-sm btn-outline-light" data-action="togglePump"
                            id="pumpToggleBtn">Basculer</button>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-config" role="tabpanel">
                <div class="reef-card">
                    <div class="fw-semibold mb-3">Programmation éclairage</div>
                    <div class="table-responsive">
                        <table class="table table-dark table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>Jour</th>
                                    <th>Allumage</th>
                                    <th>Extinction</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for key,label in day_labels %}
                                <tr>
                                    <td class="text-nowrap">{{ label }}</td>
                                    <td>
                                        <input id="light_{{ key }}_on" type="time"
                                            class="form-control form-control-sm" />
                                    </td>
                                    <td>
                                        <input id="light_{{ key }}_off" type="time"
                                            class="form-control form-control-sm" />
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-aqua" data-action="saveLightSchedule"
                                            data-day="{{ key }}">Enregistrer</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="reef-card mt-3">
                    <div class="fw-semibold mb-2">🏷️ Noms des sondes de température</div>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="form-label small">Temp 1</label>
                            <input id="tempName_temp1" class="form-control form-control-sm" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Temp 2</label>
                            <input id="tempName_temp2" class="form-control form-control-sm" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Temp 3</label>
                            <input id="tempName_temp3" class="form-control form-control-sm" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Temp 4</label>
                            <input id="tempName_temp4" class="form-control form-control-sm" />
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-aqua w-100" data-action="saveTempNames">Enregistrer</button>
                        </div>
                    </div>
                </div>
                <div class="reef-card mt-3">
                    <div class="fw-semibold mb-2">⏱️ Fréquence de rafraîchissement</div>
                    <div class="input-group input-group-sm mb-2" style="max-width: 240px;">
                        <span class="input-group-text">Intervalle (s)</span>
                        <input id="refreshInterval" type="number" step="0.5" min="0.5" class="form-control" />
                        <button class="btn btn-aqua" data-action="applyRefreshInterval">OK</button>
                    </div>
                    <p class="small text-secondary mb-0">Défaut 1 seconde. Change la fréquence de requêtes /api/state.
                    </p>
                </div>
                <div class="reef-card mt-3">
                    <div class="fw-semibold mb-2">⚙️ Configuration moteurs</div>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label small">Temps par pas (µs/step)</label>
                            <div class="input-group input-group-sm">
                                <input id="globalSpeedInput" type="number" class="form-control" />
                                <button class="btn btn-aqua" data-action="applyGlobalSpeed">Enregistrer</button>
                            </div>
                            <small class="text-secondary">Valeur utilisée lors des mouvements automatiques.</small>
                        </div>
                    </div>
                </div>
                <div class="reef-card mt-3">
                    <div class="fw-semibold mb-2">⛲ Configuration des pompes</div>
                    <p class="small text-secondary mb-3">Nom, volume (mL) et sens de rotation sont sauvegardés côté
                        serveur.</p>
                    <div class="row g-3">
                        {% for axis in ["X","Y","Z","E"] %}
                        <div class="col-md-6">
                            <div class="border rounded p-2 h-100">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="small fw-semibold">Pompe {{ axis }}</div>
                                    <button class="btn btn-sm btn-outline-light" type="button"
                                        data-action="editPumpName" data-axis="{{ axis }}">✎</button>
                                </div>
                                <div class="mb-2">
                                    <input id="pumpName_{{ axis }}" class="form-control form-control-sm"
                                        placeholder="Pompe {{ axis }}" disabled />
                                </div>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label class="form-label small">Volume (mL)</label>
                                        <input id="pumpVolume_{{ axis }}" type="number" step="0.1" min="0"
                                            class="form-control form-control-sm" />
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Sens</label>
                                        <select id="pumpDir_{{ axis }}" class="form-select form-select-sm">
                                            <option value="1">Avant (+)</option>
                                            <option value="-1">Arrière (-)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="d-grid mt-2">
                                    <button class="btn btn-sm btn-aqua" data-action="pumpSave"
                                        data-axis="{{ axis }}">Enregistrer</button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-feeder" role="tabpanel">
                <div class="reef-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <div class="fw-semibold">Nourrissage automatique</div>
                            <div class="text-secondary small">Planifier les heures de nourrissage et l'URL à appeler.
                            </div>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="feederAutoToggle">
                            <label class="form-check-label" for="feederAutoToggle">Auto</label>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th style="width:120px">Heure</th>
                                    <th style="width:120px">Méthode</th>
                                    <th>URL</th>
                                    <th style="width:140px"></th>
                                </tr>
                            </thead>
                            <tbody id="feederTableBody"></tbody>
                        </table>
                    </div>
                    <div class="mt-2 d-flex gap-2">
                        <button class="btn btn-sm btn-aqua" id="addFeederRowBtn">+</button>
                        <button class="btn btn-sm btn-primary" id="saveFeederBtn">Enregistrer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <div class="position-fixed top-0 start-50 translate-middle-x p-3"
        style="z-index: 1100; width: 100%; max-width: 420px;">
        <div id="toastContainer" class="toast-container align-items-center w-100"></div>
    </div>
    <div id="refreshLoader" class="card bg-dark bg-opacity-75 border border-secondary-subtle">
        <div class="card-body py-2 px-3">
            <div class="progress" style="height: 6px;">
                <div id="refreshProgress" class="progress-bar bg-info" role="progressbar" style="width: 0%;"></div>
            </div>
        </div>
    </div>
</body>

</html>