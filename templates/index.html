<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Reef Controller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet" />
    <style>
        #refreshLoader {
            position: fixed;
            right: 12px;
            bottom: 12px;
            width: 220px;
            z-index: 1050;
        }
    </style>
</head>

<body>
    <div class="container py-3 py-md-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
            <div>
                <h1 class="h3 mb-1">Reef Controller</h1>
                <p class="text-secondary small mb-0">Contrôle aquarium – Arduino Mega + interface web</p>
            </div>
            <div class="d-flex flex-column flex-md-row gap-2 align-items-md-center">
                <div class="d-flex align-items-center gap-2">
                    <span class="small text-secondary">Port série</span>
                    <select id="portSelect" class="form-select form-select-sm" style="min-width: 210px;"></select>
                    <button class="btn btn-sm btn-outline-light" data-action="refreshPorts">↻</button>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span id="statusBadge" class="badge reef-badge bg-secondary-subtle text-uppercase">Déconnecté</span>
                    <button class="btn btn-sm btn-outline-light" data-action="connect">Connecter</button>
                    <button class="btn btn-sm btn-outline-danger" data-action="disconnect">Déconnecter</button>
                </div>
            </div>
        </div>

        <div id="megaError" class="alert alert-danger py-2 px-3 small d-none"></div>

        <ul class="nav nav-pills mb-3" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-dashboard" type="button"
                    role="tab">🏠 Dashboard</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-logbook" type="button" role="tab">📘
                    Journal</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-pumps" type="button" role="tab">💧
                    Pompes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-heat" type="button" role="tab">🔥
                    Chauffes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-light" type="button" role="tab">💡
                    Éclairage</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-water" type="button" role="tab">🌊
                    Eau</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-water-analysis" type="button"
                    role="tab">&#129514; Analyse de l'eau</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-feeder" type="button" role="tab">🐠
                    Nourriture</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-camera" type="button" role="tab">📷
                    Caméra</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-config" type="button" role="tab">⚙️
                    Configuration</button>
            </li>


        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-dashboard" role="tabpanel">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="reef-card h-100">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="fw-semibold">🌡️ Températures</div>
                                <button class="btn btn-sm btn-aqua" data-action="readTemps">Actualiser</button>
                            </div>
                            <div class="row">
                                <div class="col-6 mb-2">
                                    <div class="temp-main" id="temp1_val">--.-°C</div>
                                    <div class="temp-small text-secondary" id="temp1_label">Temp 1</div>
                                </div>
                                <div class="col-6 mb-2">
                                    <div class="temp-main" id="temp2_val">--.-°C</div>
                                    <div class="temp-small text-secondary" id="temp2_label">Temp 2</div>
                                </div>
                                <div class="col-12">
                                    <div class="temp-main" id="temp3_val">--.-°C</div>
                                    <div class="temp-small text-secondary" id="temp3_label">Temp 3</div>
                                </div>
                                <div class="col-6 mb-2">
                                    <div class="temp-main" id="temp4_val">--.-°C</div>
                                    <div class="temp-small text-secondary" id="temp4_label">Temp 4</div>
                                </div>
                            </div>
                            <hr class="border-secondary-subtle" />
                            <div class="d-flex justify-content-between small mb-1">
                                <span>Consigne eau</span>
                                <span id="tset_water_label">--.-°C</span>
                            </div>
                            <div class="d-flex justify-content-between small">
                                <span>Consigne réserve</span>
                                <span id="tset_res_label">--.-°C</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="reef-card h-100">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="fw-semibold">💡 Lumière</div>
                            </div>
                            <div class="light-value" id="lightLuxValue">-- lx</div>
                            <div class="text-secondary small">Capteur TSL2591</div>
                            <iframe
                                src="http://192.168.1.69:3000/d-solo/ad4p5f5/gnral?orgId=1&from=1764780515724&to=1764802115724&timezone=browser&refresh=5s&panelId=panel-15&__feature.dashboardSceneSolo=true"
                                width="100%" height="220" frameborder="0"></iframe>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="reef-card h-100">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="fw-semibold">💧 Niveaux / Sécurité</div>
                                <button class="btn btn-sm btn-outline-light" data-action="readLevels">Refresh</button>
                            </div>
                            <div class="mb-2">
                                <div class="section-title mb-1">Niveaux</div>
                                <div class="d-flex flex-wrap gap-1">
                                    <span id="lvl_high" class="badge level-pill level-pill-unk">Niveau haut: ?</span>
                                </div>
                            </div>
                            <hr class="border-secondary-subtle" />
                            <div class="mb-2">
                                <div class="section-title mb-1">Protection</div>
                                <div class="d-flex align-items-center gap-2">
                                    <span id="protectBadge" class="badge reef-badge badge-protect-off">PROTECT
                                        OFF</span>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="protectChk"
                                            data-change="protectToggle" />
                                        <label class="form-check-label small" for="protectChk">Arrêt auto pompes sur
                                            niveau bas</label>
                                    </div>
                                </div>
                            </div>
                            <hr class="border-secondary-subtle" />
                            <div>
                                <div class="section-title mb-1">Servo nourrisseur</div>
                                <div class="input-group input-group-sm mb-2">
                                    <span class="input-group-text">Angle</span>
                                    <input id="servoAngle" type="number" class="form-control" />
                                    <button class="btn btn-aqua" data-action="applyServo">Set</button>
                                </div>
                                <button class="btn btn-sm btn-outline-light w-100" data-action="dispenseMacro">Séquence
                                    distribution</button>
                            </div>
                        </div>
                    </div>
                    <div class="reef-card mt-3">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">

                            <iframe
                                src="http://192.168.1.69:3000/d-solo/ad4p5f5/gnral?orgId=1&timezone=browser&refresh=5s&panelId=panel-17&__feature.dashboardSceneSolo=true"
                                width="100%" height="300" frameborder="0"></iframe>

                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-logbook" role="tabpanel">
                <div class="row g-3">
                    <div class="col-lg-4">
                        <div class="reef-card h-100">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <div class="fw-semibold mb-0">Nouvelle entree</div>
                                    <small class="text-secondary">Ajoutez vos notes et photos.</small>
                                </div>
                                <button class="btn btn-sm btn-outline-light" data-action="logbookReset">Effacer</button>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small" for="logbookText">Texte libre</label>
                                <textarea id="logbookText" class="form-control form-control-sm logbook-textarea"
                                    rows="8"
                                    placeholder="Observations, maintenance, evolution des coraux..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small" for="logbookPhotos">Photos (optionnel)</label>
                                <input type="file" id="logbookPhotos" class="form-control form-control-sm" multiple
                                    accept="image/*" />
                                <div id="logbookSelectedFiles" class="logbook-selected-files small text-secondary mt-1">
                                </div>
                                <small class="text-secondary d-block mt-1">Les fichiers sont stockes dans la galerie
                                    camera avec horodatage.</small>
                            </div>
                            <div id="logbookFormStatus" class="small text-secondary mb-2"></div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-aqua flex-fill" data-action="logbookSubmit">Enregistrer</button>
                                <button class="btn btn-outline-light" data-action="logbookRefresh"
                                    title="Recharger les entrees">Actualiser</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="reef-card h-100 logbook-history-card">
                            <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                                <div>
                                    <div class="fw-semibold mb-0">Journal de bord</div>
                                    <small class="text-secondary">Les dernieres entrees s'affichent en premier.</small>
                                </div>
                                <button class="btn btn-sm btn-outline-light"
                                    data-action="logbookRefresh">Actualiser</button>
                            </div>
                            <div id="logbookEntriesLoader" class="text-secondary small">Chargement du journal...</div>
                            <div id="logbookEntriesEmpty" class="text-secondary small d-none">Aucune entree pour le
                                moment.</div>
                            <div id="logbookEntriesList" class="logbook-timeline"></div>
                        </div>
                    </div>
                </div>
                <div class="reef-card mt-3" id="livestockCatalogZone">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <div class="fw-semibold mb-0">Catalogue Animal & Vegetal</div>
                            <small class="text-secondary">Listez les introductions, sorties et effectifs de
                                l'aquarium.</small>
                        </div>
                        <div class="d-flex align-items-center flex-wrap gap-2">
                            <div class="text-secondary small">Double-cliquez sur une ligne pour afficher la fiche
                                detaillee.</div>
                            <button class="btn btn-sm btn-outline-light" type="button" data-action="livestockRefresh">
                                Actualiser
                            </button>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-xl-6">
                            <div class="livestock-panel h-100">
                                <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-2">
                                    <div>
                                        <div class="fw-semibold mb-0">Zone Animal</div>
                                        <small class="text-secondary">Poissons, invertes et crustaces avec parametres
                                            pH/KH/GH.</small>
                                    </div>
                                    <div class="livestock-panel-actions">
                                        <span class="badge bg-secondary-subtle text-dark"
                                            id="livestockAnimalActiveBadge">Actifs: 0</span>
                                        <span class="badge bg-secondary-subtle text-dark"
                                            id="livestockAnimalInactiveBadge">Sortis: 0</span>
                                        <button class="btn btn-sm btn-aqua" type="button" data-action="livestockAdd"
                                            data-category="animal">
                                            <i class="bi bi-plus-circle"></i> Ajouter
                                        </button>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm align-middle livestock-table" data-category="animal">
                                        <thead>
                                            <tr>
                                                <th style="width: 68px;">Photo</th>
                                                <th>Espece</th>
                                                <th style="width: 140px;">Introduit</th>
                                                <th style="width: 90px;">Nombre</th>
                                                <th style="width: 140px;">Sortie</th>
                                                <th style="width: 110px;"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="livestockAnimalBody" data-category="animal">
                                            <tr>
                                                <td colspan="6" class="text-center text-secondary small py-3">Chargement
                                                    du catalogue...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-6">
                            <div class="livestock-panel h-100">
                                <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-2">
                                    <div>
                                        <div class="fw-semibold mb-0">Zone Vegetal</div>
                                        <small class="text-secondary">Plantes aquatiques et algues.</small>
                                    </div>
                                    <div class="livestock-panel-actions">
                                        <span class="badge bg-secondary-subtle text-dark"
                                            id="livestockPlantActiveBadge">Actifs: 0</span>
                                        <span class="badge bg-secondary-subtle text-dark"
                                            id="livestockPlantInactiveBadge">Sortis: 0</span>
                                        <button class="btn btn-sm btn-aqua" type="button" data-action="livestockAdd"
                                            data-category="plant">
                                            <i class="bi bi-plus-circle"></i> Ajouter
                                        </button>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm align-middle livestock-table" data-category="plant">
                                        <thead>
                                            <tr>
                                                <th style="width: 68px;">Photo</th>
                                                <th>Espece</th>
                                                <th style="width: 140px;">Introduit</th>
                                                <th style="width: 90px;">Nombre</th>
                                                <th style="width: 140px;">Sortie</th>
                                                <th style="width: 110px;"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="livestockPlantBody" data-category="plant">
                                            <tr>
                                                <td colspan="6" class="text-center text-secondary small py-3">Chargement
                                                    du catalogue...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="livestockGlobalStatus" class="text-secondary small mt-2"></div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-pumps" role="tabpanel">
                <div class="reef-card">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="fw-semibold mb-0">⛲ Pompes péristaltiques</div>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="peristalticAutoToggle">
                            <label class="form-check-label small" for="peristalticAutoToggle">Auto</label>
                        </div>
                    </div>
                    <div class="row g-2 align-items-end mb-2">
                        <div class="col-6 col-md-4 d-grid">
                            <button class="btn btn-sm btn-aqua" data-action="motorRaw" data-cmd="MTR ON">MTR ON</button>
                        </div>
                        <div class="col-6 col-md-4 d-grid">
                            <button class="btn btn-sm btn-danger" data-action="emergencyStop">MTR OFF</button>
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="mtrAutoChk" data-change="mtrAutoToggle"
                            checked />
                        <label class="form-check-label small" for="mtrAutoChk">Moteurs auto-OFF après mouvement</label>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="border rounded p-2 h-100 peristaltic-card" data-axis="X">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div id="pumpLabel_X" class="fw-semibold small">Pompe X</div>
                                        <div id="pumpInfo_X" class="small text-secondary">-</div>
                                    </div>
                                    <button class="btn btn-sm btn-aqua glow-btn" data-action="pumpGo"
                                        data-axis="X">Go</button>
                                </div>
                                <div class="d-flex justify-content-between align-items-center gap-2 mt-2 flex-wrap">
                                    <label class="form-label small mb-1 mb-md-0">Programmation</label>
                                    <span class="peristaltic-chip" id="peristalticStatus_X">Repos 🌙</span>
                                </div>
                                <div class="mt-2">
                                    <div class="input-group input-group-sm">
                                        <input type="time" class="form-control" id="pumpSchedule_X">
                                        <button class="btn btn-outline-light" data-action="savePumpSchedule"
                                            data-axis="X">Enregistrer</button>
                                        <button class="btn btn-outline-primary" data-action="runPumpSchedule"
                                            data-axis="X">Cycle auto</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-2 h-100 peristaltic-card" data-axis="Y">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div id="pumpLabel_Y" class="fw-semibold small">Pompe Y</div>
                                        <div id="pumpInfo_Y" class="small text-secondary">-</div>
                                    </div>
                                    <button class="btn btn-sm btn-aqua glow-btn" data-action="pumpGo"
                                        data-axis="Y">Go</button>
                                </div>
                                <div class="d-flex justify-content-between align-items-center gap-2 mt-2 flex-wrap">
                                    <label class="form-label small mb-1 mb-md-0">Programmation</label>
                                    <span class="peristaltic-chip" id="peristalticStatus_Y">Repos 🌙</span>
                                </div>
                                <div class="mt-2">
                                    <div class="input-group input-group-sm">
                                        <input type="time" class="form-control" id="pumpSchedule_Y">
                                        <button class="btn btn-outline-light" data-action="savePumpSchedule"
                                            data-axis="Y">Enregistrer</button>
                                        <button class="btn btn-outline-primary" data-action="runPumpSchedule"
                                            data-axis="Y">Cycle auto</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-2 h-100 peristaltic-card" data-axis="Z">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div id="pumpLabel_Z" class="fw-semibold small">Pompe Z</div>
                                        <div id="pumpInfo_Z" class="small text-secondary">-</div>
                                    </div>
                                    <button class="btn btn-sm btn-aqua glow-btn" data-action="pumpGo"
                                        data-axis="Z">Go</button>
                                </div>
                                <div class="d-flex justify-content-between align-items-center gap-2 mt-2 flex-wrap">
                                    <label class="form-label small mb-1 mb-md-0">Programmation</label>
                                    <span class="peristaltic-chip" id="peristalticStatus_Z">Repos 🌙</span>
                                </div>
                                <div class="mt-2">
                                    <div class="input-group input-group-sm">
                                        <input type="time" class="form-control" id="pumpSchedule_Z">
                                        <button class="btn btn-outline-light" data-action="savePumpSchedule"
                                            data-axis="Z">Enregistrer</button>
                                        <button class="btn btn-outline-primary" data-action="runPumpSchedule"
                                            data-axis="Z">Cycle auto</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-2 h-100 peristaltic-card" data-axis="E">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div id="pumpLabel_E" class="fw-semibold small">Pompe E</div>
                                        <div id="pumpInfo_E" class="small text-secondary">-</div>
                                    </div>
                                    <button class="btn btn-sm btn-aqua glow-btn" data-action="pumpGo"
                                        data-axis="E">Go</button>
                                </div>
                                <div class="d-flex justify-content-between align-items-center gap-2 mt-2 flex-wrap">
                                    <label class="form-label small mb-1 mb-md-0">Programmation</label>
                                    <span class="peristaltic-chip" id="peristalticStatus_E">Repos 🌙</span>
                                </div>
                                <div class="mt-2">
                                    <div class="input-group input-group-sm">
                                        <input type="time" class="form-control" id="pumpSchedule_E">
                                        <button class="btn btn-outline-light" data-action="savePumpSchedule"
                                            data-axis="E">Enregistrer</button>
                                        <button class="btn btn-outline-primary" data-action="runPumpSchedule"
                                            data-axis="E">Cycle auto</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="reef-card mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="fw-semibold">Historique pompes péristaltiques</div>
                        <small class="text-secondary">7 dernières actions par pompe</small>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle mb-0">
                            <thead>
                                <tr>
                                    <th scope="col">Pompe</th>
                                    <th scope="col">Date</th>
                                    <th scope="col">Heure</th>
                                </tr>
                            </thead>
                            <tbody id="peristalticHistoryBody">
                                <tr>
                                    <td colspan="3" class="text-center text-secondary small">Aucune action péristaltique
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-heat" role="tabpanel">
                <div class="reef-card mb-3">
                    <div class="fw-semibold mb-3">🔥 Chauffes</div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small">Eau consigne °C</label>
                            <div class="input-group input-group-sm">
                                <input id="tset_water2" type="number" step="0.1" class="form-control" />
                                <button class="btn btn-aqua" data-action="applyWater">Appliquer</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Réserve consigne °C</label>
                            <div class="input-group input-group-sm">
                                <input id="tset_res2" type="number" step="0.1" class="form-control" />
                                <button class="btn btn-aqua" data-action="applyRes">Appliquer</button>
                            </div>
                        </div>
                    </div>
                    <hr class="border-secondary-subtle" />
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="heatModeSwitch" data-change="heatMode"
                            checked />
                        <label class="form-check-label small" for="heatModeSwitch">Mode automatique</label>
                    </div>
                    <div class="d-flex align-items-center gap-2 mt-2">
                        <span id="heatStatusLabel" class="small text-secondary">Mode automatique</span>
                        <button class="btn btn-sm btn-outline-light" id="heatPowerBtn"
                            data-action="heatPower">Éteindre</button>
                    </div>
                </div>
                <div class="reef-card mb-3">
                    <div class="fw-semibold mb-2">Hystérésis (deadband)</div>
                    <div class="input-group input-group-sm" style="max-width: 220px;">
                        <span class="input-group-text">± °C</span>
                        <input id="heatHyst" type="number" step="0.05" min="0" class="form-control" />
                        <button class="btn btn-aqua" data-action="applyHeatHyst">Enregistrer</button>
                    </div>
                    <small class="text-secondary">Appliqué autour de la consigne eau (ex: ±0,3°C).</small>
                </div>
                <div class="reef-card mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="fw-semibold">🌀 Ventilation</div>
                        <button class="btn btn-sm btn-outline-light" data-action="applyAutocool">Appliquer
                            seuil</button>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between small">
                            <span>Mode</span>
                            <span class="badge reef-badge" id="autoFanModeBadge">Auto</span>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoFanChk"
                                data-change="autoFanToggle" />
                            <label class="form-check-label small" for="autoFanChk">Auto (seuil eau)</label>
                        </div>
                    </div>
                    <hr class="border-secondary-subtle" />
                    <div class="mb-3">
                        <div class="d-flex align-items-center gap-2 small">
                            <span>Seuil (°C)</span>
                            <input id="auto_thresh" type="number" step="0.1" class="form-control form-control-sm"
                                style="width: 100px;" />
                            <span id="auto_thresh_label" class="text-secondary">--.-</span>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-semibold small">Manuel</span>
                        <button class="btn btn-sm btn-outline-light" id="fanToggleBtn"
                            data-action="fanToggle">Allumer</button>
                    </div>
                </div>
            </div>

            {% set day_labels = [
            ('monday','Lundi'),
            ('tuesday','Mardi'),
            ('wednesday','Mercredi'),
            ('thursday','Jeudi'),
            ('friday','Vendredi'),
            ('saturday','Samedi'),
            ('sunday','Dimanche')
            ] %}
            <div class="tab-pane fade" id="tab-light" role="tabpanel">
                <div class="row g-3">
                    <div class="col-12">
                        <div class="reef-card">
                            <div
                                class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="lamp-visual" aria-hidden="true">
                                        <span class="lamp-icon lamp-off" id="lampIcon">💡</span>
                                    </div>
                                    <div>
                                        <div class="fw-semibold">Contrôle manuel</div>
                                        <div class="small text-secondary" id="lightStateLabel">Éteinte 🌙</div>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline-light" id="lightToggleBtn"
                                    data-action="toggleLight">Allumer</button>
                            </div>
                            <div class="mt-3 d-flex align-items-center gap-3">
                                <span class="small text-secondary">Automisation</span>
                                <input id="lightAutoSlider" type="range" min="0" max="1" step="1" class="form-range"
                                    style="width: 160px;" data-change="lightAuto" />
                                <span id="lightAutoLabel" class="fw-semibold text-white small">Auto</span>
                            </div>
                            <p class="small text-secondary mb-0">Désactivez pour gérer l'éclairage manuellement.</p>
                        </div>
                    </div>
                </div>
                <div class="reef-card mt-3">
                    <div class="fw-semibold mb-3">🗓️ Programmation éclairage</div>
                    <div class="table-responsive">
                        <table class="table table-dark table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>Jour</th>
                                    <th>Allumage</th>
                                    <th>Extinction</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for key,label in day_labels %}
                                <tr>
                                    <td class="text-nowrap">{{ label }}</td>
                                    <td>
                                        <input id="light_{{ key }}_on" type="time"
                                            class="form-control form-control-sm" />
                                    </td>
                                    <td>
                                        <input id="light_{{ key }}_off" type="time"
                                            class="form-control form-control-sm" />
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-aqua" data-action="saveLightSchedule"
                                            data-day="{{ key }}">Enregistrer</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-water" role="tabpanel">
                <div class="reef-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="fw-semibold">Suivi pH</div>
                        <button class="btn btn-sm btn-outline-light" data-action="readTemps">Rafraîchir</button>
                    </div>
                    <div class="row g-3">

                        <div class="col-md-4">
                            <div class="reef-stat">
                                <div class="reef-stat-label">Tension sonde (0-5V)</div>
                                <div class="reef-stat-value" id="ph_v_val">--.- V</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="reef-stat">
                                <div class="reef-stat-label">ADC brut</div>
                                <div class="reef-stat-value" id="ph_raw_val">----</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="reef-stat">
                                <div class="reef-stat-label">pH estimé</div>
                                <div class="reef-stat-value" id="ph_val">--.-</div>
                            </div>
                        </div>

                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <div class="reef-stat">
                                <div class="reef-stat-label" id="temp4_label2">Temp 4</div>
                                <div class="reef-stat-value" id="temp4_val2">--.-°C</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="reef-stat">
                                <div class="reef-stat-label" id="temp2_label2">Temp 2</div>
                                <div class="reef-stat-value" id="temp2_val2">--.-°C</div>
                            </div>
                        </div>
                    </div>
                    <div class="reef-card mt-3 d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <div class="d-flex align-items-center gap-3">
                            <div class="pump-visual" aria-hidden="true">
                                <span class="pump-icon" id="pumpIcon">🌀</span>
                            </div>
                            <div>
                                <div class="fw-semibold mb-1">🚰 Pompe principale</div>
                                <div class="small text-secondary" id="pumpStateLabel">Inconnue</div>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-light glow-btn" data-action="togglePump"
                            id="pumpToggleBtn">Basculer</button>
                    </div>
                    <div class="reef-card mt-3">
                        <div class="fw-semibold mb-3">Saisie manuelle des paramètres d'eau</div>
                        <form id="manualWaterQualityForm">
                            <div class="row g-3">
                                <div class="col-sm-6 col-md-4">
                                    <label class="form-label small" for="water_no3">NO3- (ppm)</label>
                                    <input type="number" step="0.01" class="form-control form-control-sm"
                                        id="water_no3" />
                                </div>
                                <div class="col-sm-6 col-md-4">
                                    <label class="form-label small" for="water_no2">NO2- (ppm)</label>
                                    <input type="number" step="0.01" class="form-control form-control-sm"
                                        id="water_no2" />
                                </div>
                                <div class="col-sm-6 col-md-4">
                                    <label class="form-label small" for="water_gh">GH (°dH)</label>
                                    <input type="number" step="0.01" class="form-control form-control-sm"
                                        id="water_gh" />
                                </div>
                                <div class="col-sm-6 col-md-4">
                                    <label class="form-label small" for="water_kh">KH (°dH)</label>
                                    <input type="number" step="0.01" class="form-control form-control-sm"
                                        id="water_kh" />
                                </div>
                                <div class="col-sm-6 col-md-4">
                                    <label class="form-label small" for="water_cl2">CL2 (ppm)</label>
                                    <input type="number" step="0.01" class="form-control form-control-sm"
                                        id="water_cl2" />
                                </div>
                                <div class="col-sm-6 col-md-4">
                                    <label class="form-label small" for="water_po4">PO4 (ppm)</label>
                                    <input type="number" step="0.01" class="form-control form-control-sm"
                                        id="water_po4" />
                                </div>
                            </div>
                            <div class="d-flex justify-content-end mt-3">
                                <button type="button" class="btn btn-sm btn-aqua" data-action="submitWaterQuality">
                                    Envoyer à InfluxDB
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="reef-card mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                        <div>
                            <div class="fw-semibold">Param&egrave;tres cibles du bac</div>
                            <p class="text-secondary small mb-0">Synth&egrave;se des poissons actifs&nbsp;: min/max
                                globaux, tranche de confort et mesure actuelle.</p>
                        </div>
                        <button class="btn btn-sm btn-outline-light" data-action="reloadWaterTargets">Rafra&icirc;chir
                            les cibles</button>
                    </div>
                    <div id="waterTargetsContent" class="water-targets-content">
                        <div class="text-secondary small">Chargement des param&egrave;tres...</div>
                    </div>
                </div>
            </div>


            <div class="tab-pane fade" id="tab-camera" role="tabpanel">
                <div class="reef-card">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                        <div>
                            <div class="fw-semibold">Caméra & surveillance</div>
                            <p class="text-secondary small mb-0">Accès direct, programmation et historique des médias.
                            </p>
                        </div>
                        <span class="badge reef-badge bg-secondary-subtle text-uppercase" id="cameraStatusBadge">Caméra
                            inconnue</span>
                    </div>
                    <ul class="nav nav-tabs camera-subnav mt-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#camera-pane-live"
                                type="button" role="tab">Direct</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#camera-pane-photos"
                                type="button" role="tab">Photos</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#camera-pane-videos"
                                type="button" role="tab">Vidéos</button>
                        </li>
                    </ul>
                    <div class="tab-content mt-3">
                        <div class="tab-pane fade show active" id="camera-pane-live" role="tabpanel">
                            <div class="row g-4">
                                <div class="col-lg-7">
                                    <div class="camera-live-wrapper">
                                        <img id="cameraLiveFeed" src="/camera_feed" alt="Flux caméra"
                                            class="camera-live-image" />
                                        <div class="camera-live-overlay d-none" id="cameraFeedUnavailable">Caméra
                                            indisponible</div>
                                    </div>
                                </div>
                                <div class="col-lg-5">
                                    <div class="camera-card">
                                        <div class="section-title mb-2">Configuration rapide</div>
                                        <div class="mb-3">
                                            <label class="form-label small" for="cameraDeviceSelect">Caméra
                                                active</label>
                                            <div class="input-group input-group-sm">
                                                <select id="cameraDeviceSelect"
                                                    class="form-select form-select-sm"></select>
                                                <button class="btn btn-outline-light"
                                                    data-action="cameraChangeDevice">Basculer</button>
                                            </div>
                                            <small class="text-secondary d-block mt-1">La caméra sélectionnée est
                                                utilisée pour le direct et les captures.</small>
                                        </div>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="cameraHFlip" />
                                            <label class="form-check-label small" for="cameraHFlip">Inversion
                                                horizontale</label>
                                        </div>
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="cameraVFlip" />
                                            <label class="form-check-label small" for="cameraVFlip">Inversion
                                                verticale</label>
                                        </div>
                                        <div class="row g-2 mb-3 camera-slider-group">
                                            <div class="col-4">
                                                <label
                                                    class="form-label small d-flex justify-content-between align-items-center"
                                                    for="cameraBrightness">
                                                    <span>Luminosité</span><span class="slider-value"
                                                        id="cameraBrightnessValue">0.00</span>
                                                </label>
                                                <input type="range" step="0.05" min="-1" max="1" class="form-range"
                                                    id="cameraBrightness" />
                                            </div>
                                            <div class="col-4">
                                                <label
                                                    class="form-label small d-flex justify-content-between align-items-center"
                                                    for="cameraContrast">
                                                    <span>Contraste</span><span class="slider-value"
                                                        id="cameraContrastValue">1.00</span>
                                                </label>
                                                <input type="range" step="0.05" min="0.1" max="4" class="form-range"
                                                    id="cameraContrast" />
                                            </div>
                                            <div class="col-4">
                                                <label
                                                    class="form-label small d-flex justify-content-between align-items-center"
                                                    for="cameraSaturation">
                                                    <span>Saturation</span><span class="slider-value"
                                                        id="cameraSaturationValue">1.00</span>
                                                </label>
                                                <input type="range" step="0.05" min="0.1" max="4" class="form-range"
                                                    id="cameraSaturation" />
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label small" for="cameraRotation">Rotation (°)</label>
                                            <select class="form-select form-select-sm" id="cameraRotation">
                                                <option value="-90">-90°</option>
                                                <option value="0" selected>0°</option>
                                                <option value="90">90°</option>
                                            </select>
                                        </div>
                                        <label class="form-label small" for="cameraAutoTime">Heure capture auto</label>
                                        <input type="time" class="form-control form-control-sm mb-3"
                                            id="cameraAutoTime" />
                                        <label class="form-label small" for="cameraSaveDirectory">Répertoire de
                                            sauvegarde</label>
                                        <input type="text" class="form-control form-control-sm mb-3"
                                            id="cameraSaveDirectory" placeholder="/home/pi/camera_media" />
                                        <button class="btn btn-sm btn-aqua w-100"
                                            data-action="cameraSaveSettings">Enregistrer</button>
                                    </div>
                                    <div class="camera-card mt-3">
                                        <div class="section-title mb-2">Contrôle manuel</div>
                                        <button class="btn btn-aqua w-100 mb-3" data-action="cameraCapturePhoto">Prendre
                                            une photo</button>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text">Durée vidéo (s)</span>
                                            <input type="number" class="form-control" id="cameraVideoDuration" min="1"
                                                value="10" />
                                            <button class="btn btn-outline-light"
                                                data-action="cameraCaptureVideo">Enregistrer</button>
                                        </div>
                                        <small class="text-secondary d-block mt-2">Les captures sont stockées dans le
                                            dossier configuré puis visibles dans les galeries.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="camera-pane-photos" role="tabpanel">
                            <div class="row g-3 align-items-center camera-gallery-controls">
                                <div class="col-sm-4">
                                    <label class="form-label small">Tri</label>
                                    <select class="form-select form-select-sm" data-gallery-sort="photos">
                                        <option value="desc">Plus récents d'abord</option>
                                        <option value="asc">Plus anciens d'abord</option>
                                    </select>
                                </div>
                                <div class="col-sm-4">
                                    <div class="form-check mt-4 mt-sm-0">
                                        <input class="form-check-input" type="checkbox" id="gallerySelectAll_photos"
                                            data-gallery-select-all="photos" />
                                        <label class="form-check-label small" for="gallerySelectAll_photos">Tout
                                            sélectionner</label>
                                    </div>
                                </div>
                                <div class="col-sm-4 text-sm-end">
                                    <button class="btn btn-sm btn-outline-danger mt-3 mt-sm-0"
                                        data-gallery-delete="photos">Supprimer la sélection</button>
                                </div>
                            </div>
                            <div class="camera-label-panel" id="photoCategoryPanel">
                                <div class="d-flex flex-column flex-md-row gap-2 align-items-md-center">
                                    <div class="flex-grow-1">
                                        <label class="form-label small mb-1" for="photoCategoryList">Catégories
                                            disponibles</label>
                                        <div id="photoCategoryList"
                                            class="d-flex flex-wrap gap-2 photo-category-badges"></div>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" id="addPhotoCategoryBtn"
                                            data-action="photoCategoryAdd">+ Catégorie</button>
                                    </div>
                                </div>
                                <div class="input-group input-group-sm mt-2 d-none" id="photoCategoryInputGroup">
                                    <input type="text" class="form-control" id="photoCategoryInput"
                                        placeholder="Nom de la catégorie" maxlength="32" />
                                    <button class="btn btn-aqua" data-action="photoCategorySave">Ajouter</button>
                                    <button class="btn btn-outline-light"
                                        data-action="photoCategoryCancel">Annuler</button>
                                </div>
                                <small class="text-secondary d-block mt-2">Cliquez sur les étiquettes situées sous une
                                    photo pour l'associer à une catégorie.</small>
                            </div>
                            <div class="camera-gallery-grid" id="galleryGrid_photos"></div>
                            <div class="camera-gallery-pagination">
                                <button class="btn btn-outline-light btn-sm"
                                    data-gallery-prev="photos">Précédent</button>
                                <span class="small text-secondary" id="galleryPageIndicator_photos">Page 1 sur 1</span>
                                <button class="btn btn-outline-light btn-sm" data-gallery-next="photos">Suivant</button>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="camera-pane-videos" role="tabpanel">
                            <div class="row g-3 align-items-center camera-gallery-controls">
                                <div class="col-sm-4">
                                    <label class="form-label small">Tri</label>
                                    <select class="form-select form-select-sm" data-gallery-sort="videos">
                                        <option value="desc">Plus récents d'abord</option>
                                        <option value="asc">Plus anciens d'abord</option>
                                    </select>
                                </div>
                                <div class="col-sm-4">
                                    <div class="form-check mt-4 mt-sm-0">
                                        <input class="form-check-input" type="checkbox" id="gallerySelectAll_videos"
                                            data-gallery-select-all="videos" />
                                        <label class="form-check-label small" for="gallerySelectAll_videos">Tout
                                            sélectionner</label>
                                    </div>
                                </div>
                                <div class="col-sm-4 text-sm-end">
                                    <button class="btn btn-sm btn-outline-danger mt-3 mt-sm-0"
                                        data-gallery-delete="videos">Supprimer la sélection</button>
                                </div>
                            </div>
                            <div class="camera-gallery-grid" id="galleryGrid_videos"></div>
                            <div class="camera-gallery-pagination">
                                <button class="btn btn-outline-light btn-sm"
                                    data-gallery-prev="videos">Précédent</button>
                                <span class="small text-secondary" id="galleryPageIndicator_videos">Page 1 sur 1</span>
                                <button class="btn btn-outline-light btn-sm" data-gallery-next="videos">Suivant</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="reef-card mt-4" id="esp32CamCard">
                    <!-- ESP32-CAM support -->
                    <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                        <div>
                            <div class="fw-semibold mb-0">ESP32-CAM distante</div>
                            <small class="text-secondary">Configurez l'oeil reseau et declenchez des captures.</small>
                        </div>
                        <span id="esp32CamStatusBadge" class="badge reef-badge bg-secondary-subtle text-uppercase">En
                            attente</span>
                    </div>
                    <div class="row g-2 align-items-end mb-3">
                        <div class="col-md-8">
                            <label class="form-label small" for="esp32CamUrlInput">URL de base</label>
                            <input type="text" id="esp32CamUrlInput" class="form-control form-control-sm"
                                placeholder="http://192.168.4.1" />
                        </div>
                        <div class="col-md-4 d-grid">
                            <button class="btn btn-aqua" data-action="esp32camSaveConfig">Enregistrer l'URL</button>
                        </div>
                    </div>
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <button class="btn btn-outline-light btn-sm" data-action="esp32camRefreshSettings">Actualiser
                            les reglages</button>
                        <button class="btn btn-outline-primary btn-sm" data-action="esp32camApplySettings">Appliquer les
                            reglages</button>
                    </div>
                    <div class="row g-3 align-items-start">
                        <div class="col-lg-8">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label small d-flex justify-content-between align-items-center"
                                        for="esp32CamBrightness">
                                        <span>Luminosite</span><span id="esp32CamBrightnessValue">0</span>
                                    </label>
                                    <input type="range" id="esp32CamBrightness" min="-2" max="2" step="1"
                                        class="form-range" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small d-flex justify-content-between align-items-center"
                                        for="esp32CamContrast">
                                        <span>Contraste</span><span id="esp32CamContrastValue">0</span>
                                    </label>
                                    <input type="range" id="esp32CamContrast" min="-2" max="2" step="1"
                                        class="form-range" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small d-flex justify-content-between align-items-center"
                                        for="esp32CamSaturation">
                                        <span>Saturation</span><span id="esp32CamSaturationValue">0</span>
                                    </label>
                                    <input type="range" id="esp32CamSaturation" min="-2" max="2" step="1"
                                        class="form-range" />
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <label class="form-label small" for="esp32CamFramesize">Resolution</label>
                            <select id="esp32CamFramesize" class="form-select form-select-sm mb-3">
                                <option value="QVGA">QVGA</option>
                                <option value="VGA">VGA</option>
                                <option value="SVGA">SVGA</option>
                                <option value="XGA">XGA</option>
                                <option value="UXGA" selected="selected">UXGA</option>
                            </select>
                            <button class="btn btn-sm btn-aqua w-100 mb-2" data-action="esp32camCapture">Prendre une
                                photo (ESP32-CAM)</button>
                            <img id="esp32CamPreview" class="img-fluid rounded border d-none" alt="Capture ESP32-CAM" />
                        </div>
                    </div>
                </div>

            </div>
            <div class="tab-pane fade" id="tab-config" role="tabpanel">
                <div class="reef-card mt-3">

                    <div class="fw-semibold mb-2">🧪 Calibration sonde pH</div>

                    <p class="small text-secondary mb-3">

                        Plongez la sonde dans la solution tampon correspondante, attendez environ 30 secondes puis

                        lancez la calibration. Les tensions mesurees mettront a jour automatiquement la pente et

                        l'offset utilises pour le calcul du pH.

                    </p>

                    <div class="row g-3">

                        <div class="col-md-4">

                            <button class="btn btn-sm btn-outline-light w-100" data-action="phCalibrate"
                                data-ref="4.01">Calibrer
                                4.01</button>

                            <div class="small text-secondary mt-1" id="phCalRef401Info">Pas encore calibre</div>

                        </div>

                        <div class="col-md-4">

                            <button class="btn btn-sm btn-outline-light w-100" data-action="phCalibrate"
                                data-ref="6.86">Calibrer
                                6.86</button>

                            <div class="small text-secondary mt-1" id="phCalRef686Info">Pas encore calibre</div>

                        </div>

                        <div class="col-md-4">

                            <button class="btn btn-sm btn-outline-light w-100" data-action="phCalibrate"
                                data-ref="9.18">Calibrer
                                9.18</button>

                            <div class="small text-secondary mt-1" id="phCalRef918Info">Pas encore calibre</div>

                        </div>

                    </div>

                    <div class="small text-secondary mt-3" id="phCalSummary">Pente: -- pH/V | Offset: --</div>

                </div>
                <div class="reef-card mt-3">


                    <div class="fw-semibold mb-2">🏷️ Noms des sondes de température</div>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="form-label small">Temp 1</label>
                            <input id="tempName_temp1" class="form-control form-control-sm" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Temp 2</label>
                            <input id="tempName_temp2" class="form-control form-control-sm" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Temp 3</label>
                            <input id="tempName_temp3" class="form-control form-control-sm" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Temp 4</label>
                            <input id="tempName_temp4" class="form-control form-control-sm" />
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-aqua w-100" data-action="saveTempNames">Enregistrer</button>
                        </div>
                    </div>
                </div>
                <div class="reef-card mt-3">
                    <div class="fw-semibold mb-2">⏱️ Fréquence de rafraîchissement</div>
                    <div class="input-group input-group-sm mb-2" style="max-width: 240px;">
                        <span class="input-group-text">Intervalle (s)</span>
                        <input id="refreshInterval" type="number" step="0.5" min="0.5" class="form-control" />
                        <button class="btn btn-aqua" data-action="applyRefreshInterval">OK</button>
                    </div>
                    <p class="small text-secondary mb-0">Défaut 1 seconde. Change la fréquence de requêtes /api/state.
                    </p>
                </div>
                <div class="reef-card mt-3">
                    <div class="fw-semibold mb-2">⚙️ Configuration moteurs</div>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label small">Temps par pas (µs/step)</label>
                            <div class="input-group input-group-sm">
                                <input id="globalSpeedInput" type="number" class="form-control" />
                                <button class="btn btn-aqua" data-action="applyGlobalSpeed">Enregistrer</button>
                            </div>
                            <small class="text-secondary">Valeur utilisée lors des mouvements automatiques.</small>
                        </div>
                    </div>
                </div>
                <div class="reef-card mt-3">
                    <div class="fw-semibold mb-2">⛲ Configuration des pompes</div>
                    <p class="small text-secondary mb-3">Nom, volume (mL) et sens de rotation sont sauvegardés côté
                        serveur.</p>
                    <div class="row g-3">
                        {% for axis in ["X","Y","Z","E"] %}
                        <div class="col-md-6">
                            <div class="border rounded p-2 h-100">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="small fw-semibold">Pompe {{ axis }}</div>
                                    <button class="btn btn-sm btn-outline-light" type="button"
                                        data-action="editPumpName" data-axis="{{ axis }}">✎</button>
                                </div>
                                <div class="mb-2">
                                    <input id="pumpName_{{ axis }}" class="form-control form-control-sm"
                                        placeholder="Pompe {{ axis }}" disabled />
                                </div>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label class="form-label small">Volume (mL)</label>
                                        <input id="pumpVolume_{{ axis }}" type="number" step="0.1" min="0"
                                            class="form-control form-control-sm" />
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Sens</label>
                                        <select id="pumpDir_{{ axis }}" class="form-select form-select-sm">
                                            <option value="1">Avant (+)</option>
                                            <option value="-1">Arrière (-)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="d-grid mt-2">
                                    <button class="btn btn-sm btn-aqua" data-action="pumpSave"
                                        data-axis="{{ axis }}">Enregistrer</button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="reef-card mt-3">
                    <div class="fw-semibold mb-2">🔁 Maintenance du service</div>
                    <p class="small text-secondary mb-3">
                        Redémarre le service systemd <code>reef</code> sur le Raspberry Pi. L'IHM sera indisponible
                        quelques secondes pendant l'opération.
                    </p>
                    <button class="btn btn-danger" data-action="restartService">Redémarrer le service Reef</button>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-water-analysis" role="tabpanel">
                <!-- Onglet Analyse de l'eau -->
                <div class="reef-card">
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                        <div class="fw-semibold mb-0">Analyse par Intelligence Artificielle</div>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-outline-light" data-action="prepareAiAnalysis" id="prepareAiBtn">
                                Preparer les donnees
                            </button>
                            <button class="btn btn-primary" data-action="get_ai_analysis" id="launchAiBtn" disabled>
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"
                                    id="aiAnalysisSpinner"></span>
                                Interroger l'IA
                            </button>
                        </div>
                    </div>
                    <div id="aiAnalysisResult" class="small text-secondary">
                        Cliquez sur "Preparer les donnees" pour recuperer l'historique puis sur "Interroger l'IA"
                        pour obtenir un diagnostic detaille.
                    </div>
                    <div class="mt-2">
                        <label class="form-label small" for="aiContextInput">Contexte additionnel pour l'analyse
                            (optionnel)</label>
                        <textarea id="aiContextInput" class="form-control form-control-sm" rows="3"
                            placeholder="Ajoutez des observations recentes, changements effectues, etc."></textarea>
                    </div>
                    <details id="aiSummaryDetails" class="small text-secondary mt-2 d-none">
                        <summary>Previsualiser les donnees envoyees a l'IA</summary>
                        <pre id="aiSummaryPreview" class="mt-2 mb-0"
                            style="white-space: pre-wrap; word-wrap: break-word; max-height: 300px; overflow:auto;">
                        </pre>
                    </details>
                    <details id="aiPromptDetails" class="small text-secondary mt-2 d-none">
                        <summary>Afficher le prompt envoye</summary>
                        <pre id="aiPromptContent" class="mt-2 mb-0"
                            style="white-space: pre-wrap; word-wrap: break-word;"></pre>
                    </details>
                </div>

                <div class="reef-card mt-3" id="aiVisionCard">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <div class="fw-semibold">Analyse IA texte + photos</div>
                            <div class="small text-secondary">Selectionnez des photos de la galerie ou posez une
                                question libre.</div>
                        </div>
                        <span class="badge bg-secondary-subtle text-dark" id="aiVisionImageCount">0/5 image(s)</span>
                    </div>
                    <div class="mt-2">
                        <label class="form-label small" for="aiVisionPrompt">Question ou contexte</label>
                        <textarea id="aiVisionPrompt" class="form-control form-control-sm" rows="3"
                            placeholder="Exemple: observe les polypes des coraux et indique si tout semble normal."></textarea>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
                        <div class="fw-semibold small mb-0">Photos selectionnables</div>
                        <button class="btn btn-sm btn-outline-light" data-action="aiGalleryRefresh"
                            type="button">Actualiser la galerie</button>
                    </div>
                    <div id="aiPhotoPicker" class="row row-cols-2 row-cols-md-4 g-2 mt-1"></div>
                    <div class="d-flex align-items-center flex-wrap gap-2 mt-3">
                        <button class="btn btn-primary" data-action="aiSendVisionPrompt" type="button">
                            Envoyer a l'IA
                        </button>
                        <div class="text-secondary small" id="aiVisionStatus"></div>
                    </div>
                    <div id="aiVisionResult"
                        class="mt-3 small bg-body-secondary bg-opacity-25 border border-secondary-subtle rounded p-2 d-none">
                    </div>
                </div>

                <div class="reef-card mt-3" id="aiSummaryCard">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <div class="fw-semibold">Resume telemetrie pour l'IA</div>
                            <div class="small text-secondary" id="aiSummaryPeriodLabel">Dernieres 72h</div>
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <select id="aiSummaryPeriodSelect" class="form-select form-select-sm">
                                <option value="last_3_days">3 derniers jours</option>
                                <option value="last_week">Semaine</option>
                                <option value="last_month">Mois</option>
                                <option value="last_year">Annee</option>
                            </select>
                            <button class="btn btn-outline-light btn-sm" data-action="aiSummaryRefresh"
                                type="button">Actualiser</button>
                        </div>
                    </div>
                    <div id="aiSummaryContent" class="small text-secondary mt-2">
                        Chargement en attente...
                    </div>
                </div>

                <div class="reef-card mt-3" id="aiWorkerCard">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <div class="fw-semibold">Worker IA local</div>
                            <div class="small text-secondary">Automatise les analyses periodiques
                                (llm/ai_worker_local.py).</div>
                        </div>
                        <span class="badge bg-secondary-subtle text-dark" id="aiWorkerStatusBadge">Etat inconnu</span>
                    </div>
                    <div id="aiWorkerStatusDetails" class="small text-secondary mt-2">
                        Chargement en attente...
                    </div>
                    <div class="d-flex gap-2 flex-wrap mt-3">
                        <button class="btn btn-primary btn-sm" data-action="aiWorkerStart"
                            type="button">Demarrer</button>
                        <button class="btn btn-outline-light btn-sm" data-action="aiWorkerStop"
                            type="button">Arreter</button>
                        <button class="btn btn-outline-light btn-sm" data-action="aiWorkerRefresh"
                            type="button">Rafraichir</button>
                    </div>
                </div>

                <div class="reef-card mt-3" id="aiInsightsCard">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="fw-semibold">Insights IA stockes</div>
                        <button class="btn btn-outline-light btn-sm" data-action="aiInsightsRefresh" type="button">
                            Rafraichir
                        </button>
                    </div>
                    <div id="aiInsightsList" class="mt-2 small text-secondary">
                        Aucun insight enregistre.
                    </div>
                </div>

                <div class="reef-card mt-3" id="aiConfigCard">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <div class="fw-semibold">Configuration IA</div>
                            <div class="small text-secondary">Selectionnez le mode local (LM Studio) ou cloud.</div>
                        </div>
                        <span class="badge bg-secondary-subtle text-dark" id="aiStatusBadge">Etat IA inconnu</span>
                    </div>
                    <div class="row g-3 align-items-end mt-1">
                        <div class="col-md-4">
                            <label class="form-label small" for="aiModeSelect">Mode IA actif</label>
                            <select id="aiModeSelect" class="form-select form-select-sm" data-change="aiModeChanged">
                                <option value="cloud">Cloud</option>
                                <option value="local">Local (LM Studio)</option>
                            </select>
                        </div>
                        <div class="col-md-4 col-lg-3">
                            <label class="form-label small">&nbsp;</label>
                            <button class="btn btn-outline-light w-100" data-action="aiTestConnection" type="button">
                                Tester la connexion IA
                            </button>
                        </div>
                    </div>
                    <div id="aiConfigStatus" class="small text-secondary mt-2"></div>
                    <div class="row g-3 mt-1">
                        <div class="col-md-6">
                            <div class="fw-semibold small mb-2">Parametres mode local</div>
                            <label class="form-label small" for="localAiBaseUrl">URL API locale</label>
                            <input type="text" id="localAiBaseUrl" class="form-control form-control-sm"
                                placeholder="http://127.0.0.1:1234/v1">
                            <label class="form-label small mt-2" for="localAiModel">Modele local</label>
                            <input type="text" id="localAiModel" class="form-control form-control-sm"
                                placeholder="openai/gpt-oss-20b">
                            <label class="form-label small mt-2" for="localAiApiKey">Cle API locale
                                (optionnelle)</label>
                            <input type="password" id="localAiApiKey" class="form-control form-control-sm"
                                placeholder="Cle locale si necessaire">
                            <div class="form-check form-check-sm mt-1">
                                <input class="form-check-input" type="checkbox" id="localAiClearKey">
                                <label class="form-check-label small" for="localAiClearKey">Supprimer la cle
                                    locale</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="fw-semibold small mb-2">Parametres mode cloud</div>
                            <label class="form-label small" for="cloudAiBaseUrl">URL API cloud</label>
                            <input type="text" id="cloudAiBaseUrl" class="form-control form-control-sm"
                                placeholder="https://api.openai.com/v1">
                            <label class="form-label small mt-2" for="cloudAiModel">Modele cloud</label>
                            <input type="text" id="cloudAiModel" class="form-control form-control-sm"
                                placeholder="gpt-4o-mini">
                            <label class="form-label small mt-2" for="cloudAiApiKey">Cle API cloud</label>
                            <input type="password" id="cloudAiApiKey" class="form-control form-control-sm"
                                placeholder="Cle OpenAI ou autre fournisseur">
                            <div class="form-check form-check-sm mt-1">
                                <input class="form-check-input" type="checkbox" id="cloudAiClearKey">
                                <label class="form-check-label small" for="cloudAiClearKey">Supprimer la cle cloud lors
                                    de
                                    l'enregistrement</label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 text-end">
                        <button class="btn btn-primary" data-action="aiConfigSave" type="button">Enregistrer la
                            configuration IA</button>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-feeder" role="tabpanel">
                <div class="reef-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <div class="fw-semibold">Nourrissage automatique</div>
                            <div class="text-secondary small">Planifier les heures de nourrissage et l'URL à appeler.
                            </div>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="feederAutoToggle">
                            <label class="form-check-label" for="feederAutoToggle">Auto</label>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm align-middle feeder-table">
                            <thead>
                                <tr>
                                    <th style="width:120px">Heure</th>
                                    <th style="width:120px">Méthode</th>
                                    <th>URL</th>
                                    <th style="width:220px">Pompe</th>
                                    <th style="width:140px"></th>
                                </tr>
                            </thead>
                            <tbody id="feederTableBody"></tbody>
                        </table>
                    </div>
                    <div class="mt-2 d-flex gap-2">
                        <button class="btn btn-sm btn-aqua" id="addFeederRowBtn">+</button>
                        <button class="btn btn-sm btn-primary" id="saveFeederBtn">Enregistrer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <div class="position-fixed top-0 start-50 translate-middle-x p-3"
        style="z-index: 1100; width: 100%; max-width: 420px;">
        <div id="toastContainer" class="toast-container align-items-center w-100"></div>
    </div>
    <div id="reefPopin" class="reef-popin d-none" role="dialog" aria-modal="true">
        <div class="reef-popin-dialog">
            <div class="reef-popin-icon" id="reefPopinIcon">💬</div>
            <div class="reef-popin-message" id="reefPopinMessage">Message</div>
            <div class="reef-popin-actions">
                <button class="btn btn-outline-light" id="reefPopinCancel">Annuler</button>
                <button class="btn btn-aqua" id="reefPopinConfirm">OK</button>
            </div>
        </div>
    </div>

    <div id="mediaViewer" class="media-viewer d-none" role="dialog" aria-modal="true">
        <div class="media-viewer-backdrop"></div>
        <div class="media-viewer-dialog">
            <button class="media-viewer-close" id="mediaViewerClose" aria-label="Fermer">&times;</button>
            <div class="media-viewer-content" id="mediaViewerContent"></div>
        </div>
    </div>

    <div id="refreshLoader" class="card bg-dark bg-opacity-75 border border-secondary-subtle">
        <div class="card-body py-2 px-3">
            <div class="progress" style="height: 6px;">
                <div id="refreshProgress" class="progress-bar bg-info" role="progressbar" style="width: 0%;"></div>
            </div>
        </div>
    </div>
</body>

</html>